## Here include some basic information
## Name of author:Robert Wynne
## Date:24/01/2020
## Program name: rscript_rna_seq-1.R
## Purpose of the script:RNAseq analysis
## This script does XX, YYY and ZZZ.

## Introduction:
This script takes transcript estimates (quant.sf) files generated by Salmon as input, calculates gene-level counts using tximport and performs differential expression analysis using DESeq2.

The script outputs:

1. Load libraries:

```{r, message = FALSE}
## Load libraries:
#library(apeglm)
library(biomaRt)
library(ggplot2)
library(DESeq2)
library(RCurl)
library(stringi)
library(tximport)
# Check version using sessionInfo
# E.g. sessionInfo("DESeq2")
```

2. Read in input files. The input files for this script are generated by the quasialigner, salmon, which quantifies expression of individual transcript. For differential expression analysis, we want to generate gene-level counts for investigating differences in gene expression between one or more treatment groups.
 
```{r, message = FALSE}
# read in salmon output files
## JC - This step reads in a list of sample names rather than the actual files
## JC - Don't use capital letters in variable names - 'RNAsamples' should
## be 'rna_samples'
## JC - Actually state what is in 'RNAseq_Sample_File_Reduced.txt' - how many
## columns and what they relate to i.e. First column contains sample names;
## Second column contains the sex of the samples; etc.
rna_sample_info <- read.table(file = "data/RNAseq_Sample_File_Reduced.txt",
                              header = TRUE)
#check the data
## JC - See comment above:
head(rna_sample_info)
## RNASeq analysis for brain samples:
# give R the file path needed, we do this by taking any file from the dirctory with
#'quant.sf attached to the end of the name
## JC - Create a vector containing a list of paths for each sample
## listed in the sample information file read in and stored as 'rna_sample_info'.
## The function 'file.path' will look in the directory 'RNASEQ' and then within indivdiual folders contained within that directory. Each of the individual folders in that directory should contain folders for each sample listed in the sample information file. Within each of these folders, files all end in the file extension 'quant.sf', which is the
## default naming scheme by Salmon.
files <- file.path("data/salmon_output/",
                   rna_sample_info$sample,
                   "quant.sf")
# At present, all samples are being loaded in as input, which contains a mix of liver and brain samples.
#create a dataframe which labels all of the brain files as true
#this will help is separate the organs as we will be looking at the
#brain and liver separetly
files_df <- as.data.frame(cbind(files,
                                grepl(pattern = "_B",
                                      x = files)))
## creating a subset of just brain samples
## JC: This step subsets the dataframe 'files_df' by checking if values in column 'V2'
## are annotated as 'TRUE'. If so, it subsets these entire lines into a new dataframe
## called 'files_brain_df'.
files_brain_df <- subset(files_df,
                         V2 == TRUE)
## creating a subset with all of the discriptive information for all of the brain samples
##from the 'RNAseqsamples' document
## JC - Again, 'subset' is the function, it takes dataframes as input and creates dataframes
## as output. For this command, the dataframe 'RNAsamples' is subset by the column which contains
## 'tissue' information and only rows related to samples annotated as 'brain' are subsetted into
## a new dataframe 'RNAsamples_brain'.
rna_sample_info_brain <- subset(rna_sample_info,
                                tissue == "Brain")

## specify the path to the files using the appropriate columns of samples
## also need to link transcripts to genes for this dataset:
tx2gene <- read.table("data/combined_transcript_to_gene.txt")

## Ensure that names are of class character:
files <- as.character(files_brain_df$files)

## Generate gene level counts:
txi <- tximport(files,
                type = "salmon",
                tx2gene = tx2gene)

### group factors for different comparasons
rna_sample_info_brain$group <- paste(rna_sample_info_brain$environment,
                                     "_",
                                     rna_sample_info_brain$phenotype,
                                     sep = "")
```

3. Objective 1:
For objective 1, we define a global that inclues effects of phenotype (smolt versus resident) and environment (fresh versus salt):

```{r, message = FALSE}
## Generate a deseq2 object:
dds_txi_phen_env <- DESeqDataSetFromTximport(txi,
                                             colData = rna_sample_info_brain,
                                             design  = ~phenotype + environment)

### using the results from above to run the DESeq analysis, compare above model with one with only environment. This allows us to get at the significance of the phenotype effect:
dds_env <- DESeq(dds_txi_phen_env,
                 test = "LRT",
                 reduced = ~environment)

## Check names of comparisons:
resultsNames(dds_env)

## Extract results:
phenotype_effect_contr_env <- results(dds_env,
                                      name = "phenotype_Smolt_vs_NonSmolt")

## Extract significant phenotype genes:
phenotype_effect_contr_env$absL2FC <- abs(phenotype_effect_contr_env$log2FoldChange)
phenotype_effect_contr_env_sig     <- subset(x = phenotype_effect_contr_env,
                                             padj < 0.05 &
                                             absL2FC > 1)

## Create gene list:
phenotype_contr_env_sig_genes <- row.names(phenotype_effect_contr_env_sig)
length(phenotype_contr_env_sig_genes)

### using the results from above to run the DESeq analysis,
## compare above model with one with only phenotype, which allow us to get at the effect of environment:
dds_phen <- DESeq(dds_txi_phen_env,
             test = "LRT",
             reduced = ~phenotype)

## Check names of comparisons:
resultsNames(dds_phen)

## Extract significant results:
env_effect_contr_phen <- results(dds_phen,
                                 name = "environment_salt_vs_fresh")

## Extract significant environment genes:
env_effect_contr_phen$absL2FC <- abs(env_effect_contr_phen$log2FoldChange)
env_effect_contr_phen_sig <- subset(x = env_effect_contr_phen,
                                    padj < 0.05 &
                                    absL2FC > 1)

## Create gene list:
env_contr_phen_sig_genes <- row.names(env_effect_contr_phen_sig)
length(env_contr_phen_sig_genes)
```

4. So we now have two sets of genes:  
1 = "phenotype genes" (phenotype_contr_env_sig_genes), i.e. genes that are differentially expressed between smolts and residents, after having controlled statistically for environment
2 = "environment genes" (env_contr_phen_sig_genes), i.e. genes that are differentially expressed between fresh and salt water, after having controlled statistically for phenotype.

```{r, message = FALSE}
# We are now in a position to make our venn diagram (see Euler plot code) showing the extent to which these phenotype and environment genes overlap.  But we can see this in numbers like this:
phen_and_env_genes <- intersect(phenotype_contr_env_sig_genes,
                                env_contr_phen_sig_genes)
length(phen_and_env_genes)

# And here is the number of unique phenotype genes (i.e. DE between phenotypes but not between environments):
phen_not_env_genes <- setdiff(phenotype_contr_env_sig_genes,
                              env_contr_phen_sig_genes)
length(phen_not_env_genes)

# And here is the number of unique environment genes (i.e. DE between environments but not between phenotypes):
env_not_phen_genes <- setdiff(env_contr_phen_sig_genes,
                              phenotype_contr_env_sig_genes)
length(env_not_phen_genes)
```

5. Generate PCA plots to explore expression profiles amongst individuals and treatments:

```{r, message = FALSE}
## Transform data for plotting:
vsd <- vst(dds_txi_phen_env,
           blind = FALSE)

## Calculate principal components:
pca <- prcomp(t(assay(vsd)))

## check the proportion of variance explained by each PC:
summary(pca)

## Here set the two principal components that you want to compare:
## It can any combination between 1 and 22:
first_pc <- 1
second_pc <- 2

## Create function for plotting:
plotPCA.san <- function(object,
                        intgroup = "condition",
                        ntop = 1000,
                        returnData = FALSE) {
  rv <- rowVars(assay(object))
  select <- order(rv, decreasing = TRUE)[seq_len(min(ntop,
                                                     length(rv)))]
  pca <- prcomp(t(assay(object)[select, ]))
  percentVar <- pca$sdev ^ 2 / sum(pca$sdev ^ 2)
  if (!all(intgroup %in% names(colData(object)))) {
    stop("the argument 'intgroup' should specify columns of colData(dds)")
  }
  intgroup.df <- as.data.frame(colData(object)[, intgroup, drop = FALSE])
  group <- if (length(intgroup) > 1) {
    factor(apply(intgroup.df, 1,
                 paste,
                 collapse = " : "))
  }
  else {
    colData(object)[[intgroup]]
  }
  ## Select the PCAs and percentVar that you like instead of 1 and 2
  d <- data.frame(PC1 = pca$x[, first_pc],
                  PC2 = pca$x[, second_pc],
                  group = group, 
                  intgroup.df,
                  name = colData(vsd)[,1])
  if (returnData) {
    attr(d, "percentVar") <- percentVar[first_pc:second_pc]
    return(d)
  }
    ggplot(data = d,
           aes_string(x = "PC1",
                      y = "PC2",
                      color = "group")) +
            geom_point(data = d,
                       aes(fill = group),
                       colour = "black",
                       pch = 21,
                       size = 3) +
            xlab(paste0("PC", first_pc, ": ",
                        round(percentVar[first_pc] * 100),
                        "% variance")) +
            ylab(paste0("PC", second_pc, ": ",
                        round(percentVar[second_pc] * 100),
                        "% variance")) +
            coord_fixed() +
            #geom_text_repel(size = 3) +
            theme_bw() +
            theme(axis.title = element_text(size = 15,
                                            face = "bold"),
                  axis.text = element_text(size = 10,
                                           face = "plain"),
                  legend.title = element_text(size = 10,
                                              face = "bold")) +
            scale_fill_discrete(name = "Phenotype",
                                  labels = c("Resident-FW",
                                             "Resident-SW",
                                             "Smolt-SW"))
}

## Generate plot:
brain_pca_plot <- plotPCA.san(vsd,
                              intgroup = c("group"))

## Plot:
brain_pca_plot

## Create output directory:
dir.create(path = "results/figures_for_ms/",
           recursive = TRUE)

## Output image:
ggsave(brain_pca_plot,
       file = "results/figures_for_ms/figure_1b_brain_pca.png",
       height = 6,
       width = 6)

## Save as R object:
saveRDS(brain_pca_plot,
        file = "results/figures_for_ms/figure_1b_brain_pca.rds")

## Output image:
ggsave(brain_pca_plot,
       file = "results/figures_for_ms/figure_1b_brain_pca.pdf",
       height = 6,
       width = 6)
```

6. Save everything:

```{r, message = FALSE}
save.image(file = "results/DESeq2_output_brain.RData")
```

7. Run lintr to check style guide:

```{r, message = FALSE}
lintr::lint(file = "run_deseq2_to_pca_brain.Rmd")
```